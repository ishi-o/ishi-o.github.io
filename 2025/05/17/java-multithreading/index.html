<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=consolas:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ishi-o.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"github","dark":"github-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"language":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="article">
<meta property="og:title" content="Java: 多线程编程">
<meta property="og:url" content="https://ishi-o.github.io/2025/05/17/java-multithreading/index.html">
<meta property="og:site_name" content="Ishio">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-05-17T00:00:00.000Z">
<meta property="article:modified_time" content="2025-12-06T07:59:44.168Z">
<meta property="article:author" content="ishio">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="multithreading">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ishi-o.github.io/2025/05/17/java-multithreading/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://ishi-o.github.io/2025/05/17/java-multithreading/","path":"2025/05/17/java-multithreading/","title":"Java: 多线程编程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java: 多线程编程 | Ishio</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.10.1/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ishio</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">Java多线程编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#runnable%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.1.</span> <span class="nav-text">Runnable接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#thread%E7%B1%BB"><span class="nav-number">1.2.</span> <span class="nav-text">Thread类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9F%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="nav-number">1.3.</span> <span class="nav-text">传统线程同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java.util.concurrent.locks%E4%B8%8Esemaphore"><span class="nav-number">1.4.</span> <span class="nav-text">java.util.concurrent.locks与Semaphore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#callablet%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-number">1.5.</span> <span class="nav-text">Callable&lt;T&gt;接口与异步线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E5%AE%83api"><span class="nav-number">1.6.</span> <span class="nav-text">其它API</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ishio</p>
  <div class="site-description" itemprop="description">Just for fun!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">89</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ishi-o" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ishi-o" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/03/04/java-base/" rel="bookmark">
        <time class="popular-posts-time">2025-03-04</time>
        <br>
      Java: 基本语法
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/03/06/java-oop/" rel="bookmark">
        <time class="popular-posts-time">2025-03-06</time>
        <br>
      Java: 面向对象编程
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/05/04/java-stream-api/" rel="bookmark">
        <time class="popular-posts-time">2025-05-04</time>
        <br>
      Java: 函数式编程
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/07/14/spring-validation/" rel="bookmark">
        <time class="popular-posts-time">2025-07-14</time>
        <br>
      Spring framework: Validation API
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ishi-o.github.io/2025/05/17/java-multithreading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ishio">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ishio">
      <meta itemprop="description" content="Just for fun!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java: 多线程编程 | Ishio">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java: 多线程编程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-17 00:00:00" itemprop="dateCreated datePublished" datetime="2025-05-17T00:00:00+00:00">2025-05-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-12-06 07:59:44" itemprop="dateModified" datetime="2025-12-06T07:59:44+00:00">2025-12-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/" itemprop="url" rel="index"><span itemprop="name">Programming</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming/Java/Java-SE/" itemprop="url" rel="index"><span itemprop="name">Java SE</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>4.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>15 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><!-- placeholder -->
<span id="more"></span>
<h2 id="java多线程编程"><code>Java</code>多线程编程</h2>
<h3 id="runnable接口"><code>Runnable</code>接口</h3>
<ul>
<li>所有类，如果希望让它单独作为一个线程运行，可以<strong>继承</strong><code>Thread</code>类并重写<code>void run()</code>方法</li>
<li>所有类，如果希望让它单独作为一个线程运行，更常用的方法是<strong>实现</strong><code>Runnable</code><strong>接口</strong>以便用多态特性被调用</li>
<li><code>Runnable</code>接口要求实现<code>void run()</code>方法，当这个类作为线程运行时，运行的就是这个<code>run()</code>方法
使用这种方法，实现了<code>Runnable</code>接口的类称为线程任务对象，传递给<code>Thread</code>运行，创建的<code>Thread</code>对象称为线程对象</li>
</ul>
<h3 id="thread类"><code>Thread</code>类</h3>
<ul>
<li><code>Thread</code>的常用构造器：
<ul>
<li><code>Thread()</code>：创建空线程</li>
<li><code>Thread(Runnable task, String name)</code>：将实现了<code>Runnable</code>接口的方法引用传递给它，并命名为<code>name</code></li>
</ul></li>
<li><code>java</code>线程包括七个状态：
<ul>
<li><code>New</code>：新建的线程，尚未执行</li>
<li><code>Runnable</code>：正在执行<code>run()</code>的线程</li>
<li><code>Blocked</code>：因阻塞而被挂起的线程</li>
<li><code>Waiting</code>：因某些原因在等待的线程</li>
<li><code>Timed Waiting</code>：因主动调用<code>Thread.sleep()</code>而计时等待的线程</li>
<li><code>Terminated</code>：终止的线程，<code>run()</code>因各种原因而结束</li>
</ul></li>
<li><code>start()</code>：启动一个线程，使其开始以另一个线程的形式执行<code>run()</code>
在主线程直接调用某个线程类的<code>run()</code>无法达到多线程的效果，必须通过<code>start()</code>在<code>JVM</code>中登记</li>
<li><code>join()</code>：使当前线程等待调用该方法的线程实例结束，再继续运行
<code>join(long)</code>：使当前线程仅等待有限时间，其它同上</li>
<li><code>interrupt()</code>：使该线程的中断标志位置<code>1</code>，可以通过<code>isInterrupted()</code>循环检查，实现中断线程的效果
但<code>interrupt()</code>并不立刻生效，仅仅是发出一个中断请求
而且当外部线程调用该线程的<code>interrupt()</code>方法时，若该线程处于等待状态(例如调用<code>join()</code>或<code>sleep()</code>)，则<code>join()</code>或<code>sleep()</code>等会抛出<code>InterruptedException</code>异常</li>
<li><code>volatile</code>关键字：由于<code>JVM</code>的内存模型，在线程修改共享变量时不会立刻写回主内存
而<code>volatile</code>修饰的变量则会使<code>JVM</code>在读取时总是读取最新值、写入时总是立刻写入
但<code>volatile</code>并不保证原子性，在读写含有多个字段的<code>volatile</code>变量时可能会有问题</li>
<li><code>setDaemon(true)</code>：一个线程默认是非守护线程，<code>JVM</code>进程会等待所有的非守护线程结束后再结束
但一些线程是无限循环的，可以调用<code>setDaemon(true)</code>将它们设置为守护线程，<code>JVM</code>进程结束时不会关心它们是否结束
守护线程不能占有任何需要显式关闭的资源，守护线程本身无法保证这些资源能在<code>JVM</code>进程结束时关闭</li>
</ul>
<h3 id="传统线程同步">传统线程同步</h3>
<ul>
<li><p>不同线程在读写同一份资源、或需要相互协作时，就需要考虑线程同步问题
除非资源是只读的，例如不可变类型，则不需要考虑线程同步
大部分标准库中的类为了提高性能，都是非线程安全的，涉及到非线程安全的读写操作时，必须手动添加线程同步代码以保证线程安全</p></li>
<li><p><code>synchronized</code>关键字：</p>
<ul>
<li>作用于对象时，会对该对象加锁</li>
<li>修饰实例方法时，等价于作用于<code>this</code></li>
<li>修饰静态方法时，等价于作用于所在类的<code>class</code>实例</li>
<li>一般不用该关键字修饰方法，因为会导致加锁混乱、不明确且在很多情况会使两个本不冲突的方法变为冲突
使用<code>synchronized</code>的代码块无法并发执行，且加锁解锁有额外开销
对某对象加锁，不代表其它线程就无法访问该对象，如果一个线程对该对象加锁而另一个线程并不这样做，则仍存在线程同步问题</li>
</ul></li>
<li><p><code>JVM</code>的基础原子操作：除<code>long</code>、<code>double</code>以外的任意变量的赋值操作
涉及多行的赋值操作时，仍需要用<code>synchronized</code>修饰代码块</p></li>
<li><p>可重入锁：<code>JVM</code>允许<strong>同一个线程</strong>重复获取同一个锁，其本质是一个信号量，进入/退出<code>synchronized</code>代码块使信号量加/减<code>1</code></p></li>
<li><p>死锁的必要条件：互斥、不可抢占、占有并等待、循环等待，只要破坏其中一种条件即可避免死锁</p>
<ul>
<li>破坏循环等待：所有线程获取同一组锁的顺序保持一致，这是最简单的一种方案</li>
<li>互斥不可破坏，破坏不可抢占可能导致混乱，破坏占有并等待必须一次性分配需要的资源、资源利用率低且可能导致饥饿</li>
</ul></li>
<li><p>继承自<code>Object</code>的<code>wait()</code>：可使该线程暂时放弃调用<code>wait()</code>的对象锁，进入等待状态直至被唤醒，唤醒后立刻尝试重新请求这个对象锁
需要注意这不是作用于线程类对象的，而是<strong>作用于被加锁的资源</strong></p></li>
<li><p>继承自<code>Object</code>的<code>notify()</code>和<code>notifyAll()</code>：可随机唤醒某一个等待该资源的线程/唤醒全部等待该资源的线程
同上，这两者作用于被加锁的资源，通常后者更安全</p>
<ul>
<li><code>notify()</code>可能会唤醒同类线程，导致活锁或死锁，例如生产者消费者问题：
两个消费者阻塞<span
class="math inline">→</span>生产者<code>P1</code>唤醒消费者<code>C1</code><span
class="math inline">→</span>两个生产者阻塞<span
class="math inline">→</span>消费者<code>C1</code>消耗资源，但唤醒同类消费者<code>C2</code><span
class="math inline">→</span>两个消费者阻塞，至此所有线程均阻塞，造成死锁</li>
<li>使用<code>notifyAll()</code>，至少能唤醒一个非同类线程，而其它同类线程应该继续等待，所以<strong><code>wait()</code>应该在循环</strong>里而非<code>if</code>语句块中</li>
</ul></li>
<li><p><code>JVM</code>线程同步原理是对象监视器，<code>Object</code>的<code>wait()</code>和<code>notify()</code>相当于每个变量都可以作为信号量的封装，由于<strong><code>wait()</code>使线程可以短暂释放已获得的锁</strong>，使其不需要像操作系统课程上讲的那般麻烦(需要互斥信号量与同步信号量且互斥信号量的<code>PV</code>操作紧贴临界区)，而是使同步信号量围绕着互斥资源通过<code>wait()</code>和<code>notify()</code>进行同步
例如在生产者消费者问题中，互斥资源的空/满可以化作<code>while</code>中的条件，充当同步信号量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个线程同步的生产者消费者队列类</span></span><br><span class="line"><span class="keyword">private</span> Queue&lt;Integer&gt; q;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">final</span> <span class="variable">MAX_SIZE</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="comment">// Consumer</span></span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (size == <span class="number">0</span>) &#123; <span class="comment">// Condition: Empty</span></span><br><span class="line">        wait();</span><br><span class="line">    &#125;</span><br><span class="line">    e = q.poll(); <span class="comment">// consume</span></span><br><span class="line">    --size;</span><br><span class="line">    notifyAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Provider</span></span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (size == MAX_SIZE) &#123; <span class="comment">// Condition: Full</span></span><br><span class="line">        wait();</span><br><span class="line">    &#125;</span><br><span class="line">    q.offer(e); <span class="comment">// provide</span></span><br><span class="line">    ++size;</span><br><span class="line">    notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3
id="java.util.concurrent.locks与semaphore"><code>java.util.concurrent.locks</code>与<code>Semaphore</code></h3>
<ul>
<li><code>synchronized</code>的加锁机制是<strong>悲观锁</strong>、<strong>重量级锁</strong>、<strong>阻塞的</strong>，这种锁适合竞争激烈的多线程同步场景，线程先必须获得锁(进入或退出<code>Monitor</code>)才能读写对象</li>
<li><code>java.util.concurrent</code>是<code>Java 5</code>开始提供的高级并发包，以下是需要提前了解的一些概念
<ul>
<li>乐观锁：线程无需获取锁地尝试修改，在修改时检查是否冲突
理念是估计在读过程中不会有其它线程在写
乐观读锁在读多写少的场景中好处显而易见：一是乐观读锁不排它，减少写锁饥饿的情况；二是因为写少，乐观读大概率成功而减少了悲观锁的阻塞开销</li>
<li><code>CAS</code>(<code>Compare And Swap</code>或<code>Compare And Set</code>)机制是实现乐观锁的一种方式：线程查询内存中的值和此前读取的值是否相同，若相同则更新，否则失败
若失败则读取内存中的值，循环地进行<code>CAS</code>直至更新成功</li>
<li><code>CAS</code>机制存在<code>ABA</code>问题，即线程<code>T1</code>尝试通过<code>CAS</code>读写时，虽然内存值和此前读取的值一致，但这个内存值<code>A</code>可能被另一个线程先改为<code>B</code>再改为<code>A</code>，在<code>T1</code>看来没有改变过的资源实际上被其它线程更改过
因此实现上对资源的更改会添加时间戳/版本号</li>
<li><code>CAS</code>机制有时会配合自旋的机制：
<strong>自旋锁</strong>优点在于可避免不必要的上下文切换开销，缺点在于循环导致的<code>CPU</code>忙等
自旋锁仅在<code>CPU</code><strong>多核</strong>的并行处理场景中，线程能在忙等中获取其它线程释放的资源时才有效
接下来从完全悲观到完全乐观地介绍<code>java.util.concurrent</code>提供的线程同步机制</li>
</ul></li>
<li><code>Lock</code>接口：可以替代<code>synchronized</code>，是一种显式锁，由代码层面而非语法层面实现加锁和解锁，其实现类是对<code>synchronized</code>的封装
<code>Lock</code>是悲观锁
<ul>
<li><code>lock()</code>：显式加锁</li>
<li><code>unlock()</code>：需要在<code>finally</code>块中解锁</li>
<li><code>tryLock()</code>和<code>tryLock(long, TimeUnit)</code>：<code>Lock</code>支持非阻塞获取锁或有限忙等地获取锁，前者仅尝试一次、后者在有限时间内循环尝试
返回<code>true</code>表示获取成功</li>
<li><code>newCondition()</code>：返回一个<code>Condition</code>对象，<code>Lock</code>支持多条件锁，与<code>synchronized</code>单锁相区别
<code>ReentrantLock</code>是<code>Lock</code>的实现类之一，译为“可重入锁”</li>
<li>支持公平锁，在构造时传递<code>true</code>即可
公平锁即每次向等待队列加入新的线程时，它无法插队，保证每次获取锁的线程是队列中等待时间最长的线程</li>
</ul></li>
<li><code>Condition</code>接口：表示某条件的等待队列，如上文传统的线程同步代码中，由于空/满这两种条件使不同类线程在同一等待队列中，因此会出现死锁现象而必须用<code>notifyAll()</code>来唤醒非同类线程
而<code>Condition</code>和<code>Lock</code>允许在一个锁对象上分配多个不同条件的等待队列，能保证每次唤醒都能唤醒非同类线程
<ul>
<li><code>await()</code>：使线程在该条件上短暂地释放锁，进入等待状态，被唤醒后重新尝试获取</li>
<li><code>await(long, TimeUnit)</code>：可以在有限时间内地等待</li>
<li><code>signal()</code>：唤醒在该条件上等待的某个线程</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Queue&lt;Integer&gt; q;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MAX_SIZE</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notempty</span> <span class="operator">=</span> lock.newCondition(), notfull = lock.newCondition();</span><br><span class="line"><span class="comment">// Consumer</span></span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        notempty.await();</span><br><span class="line">    &#125;</span><br><span class="line">    e = q.poll();</span><br><span class="line">    --size;</span><br><span class="line">    notfull.signal();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Provider</span></span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (size == MAX_SIZE) &#123;</span><br><span class="line">        notfull.await();</span><br><span class="line">    &#125;</span><br><span class="line">    q.offer(e);</span><br><span class="line">    ++size;</span><br><span class="line">    notempty.signal();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>ReadWriteLock</code>接口：有时排它锁过于重量，在多读少写的场景下，希望允许多个线程同时读，这个接口就用于这种场景
<ul>
<li><code>readLock()</code>：获取读锁</li>
<li><code>writeLock()</code>：获取读锁
类的内部会维护，若有线程占有读锁，则不会有线程能占有写锁，反之亦然；若没有线程占有写锁，则允许多个线程占有读锁
虽然它实现了读写分离，但它仍是<strong>悲观锁</strong>，因此也可能导致需要<strong>写锁的线程饥饿</strong>
<code>ReentrantReadWriteLock</code>是<code>ReadWriteLock</code>的实现类之一，是可重入锁</li>
</ul></li>
<li><code>AQS</code>框架：</li>
<li><code>StampedLock</code>类：<code>Java 8</code>开始提供的<strong>乐观读锁</strong>和<strong>读写分离的悲观锁</strong>两者的封装锁，在互斥上可替代<code>ReadWriteLock</code>，但要注意它不是可重入锁、不支持公平锁
<ul>
<li><code>StampedLock</code>和<code>ReadWriteLock</code>一样有<code>readLock()</code>和<code>writeLock()</code>方法，用于获取读锁和写锁
但它们的实现有所区别：它们不返回<code>Lock</code>对象而是在内部就调用了锁的<code>lock()</code>方法，然后返回<code>long</code>类型的版本号<code>stamp</code></li>
<li>因此需要使用<code>unlockRead(stamp)</code>和<code>unlockWrite(stamp)</code>释放掉这个版本号的读写锁</li>
<li><code>StampedLock</code>还支持<strong>乐观读锁</strong>，通过<code>tryOptimisticRead()</code>尝试获取乐观读锁的版本号<code>stamp</code>，然后通过<code>validate(stamp)</code>检验，<strong>乐观锁不需要解锁，因为本质上并没有加锁操作</strong>
如前文所说，乐观锁不排它，乐观读过程中允许其它线程写，如果检验成功，说明加乐观读锁途中没有线程占有死锁
如果检验不成功则有两种选择：自旋地重复乐观读、悲观读</li>
<li>同<code>Lock</code>一样支持非阻塞或有限阻塞地获取悲观读锁和悲观写锁</li>
<li>支持锁转换：
<code>tryConvertToReadLock(stamp)</code>：若<code>stamp</code>有效，原子地，悲观读锁则返回其本身、悲观写锁则释放它并返回悲观读锁、乐观读锁则非阻塞地请求一个悲观读锁
<code>tryConvertToWriteLock(stamp)</code>：若<code>stamp</code>有效，原子地，悲观读锁且写锁空闲则返回写锁、悲观写锁则返回其本身、乐观读锁则非阻塞地请求一个悲观写锁
<code>tryConvertToOptimisticRead(stamp)</code>：若<code>stamp</code>有效，原子地，悲观锁则释放它们并返回乐观读锁、有效的乐观锁则返回其本身</li>
<li>但<code>StampedLock</code>不支持基于条件的线程间协作，因此只适用于单个资源的互斥读写场景</li>
</ul></li>
<li><code>Semaphore</code>：信号量可以被最多<code>N</code>个线程获取，但不支持基于条件的线程间协作，用于复数个资源的互斥获取，它也支持公平锁
<ul>
<li><code>acquire()</code>：阻塞地获取该信号量</li>
<li><code>release()</code>：需要在<code>finally</code>块中释放</li>
<li><code>tryAcquire()</code>和<code>tryAcquire(long, TimeUnit)</code>：非阻塞地或有限阻塞地获取信号量</li>
</ul></li>
</ul>
<h3
id="callablet接口与异步线程池"><code>Callable&lt;T&gt;</code>接口与异步线程池</h3>
<ul>
<li><code>Callable&lt;T&gt;</code>接口：由于<code>Runnable</code>的<code>run()</code>没有返回值且不允许抛出异常，因此<code>Callable&lt;T&gt;</code>诞生了，是单方法接口，包含方法<code>T call() throws Exception</code></li>
<li><code>java</code>线程池提供了<strong>多线程异步</strong>的功能，能更好地利用多核资源
所谓同步，即各个任务有一定的执行顺序，一些任务必须等待其它任务完成后，利用其计算结果才能继续运行；异步是各个任务没有执行顺序，任务通过回调函数或其它手段获取其它任务的计算结果，在这段时间内可以执行其它计算
同步异步与线程个数没有必然联系，单线程异步可以通过检测事件循环实现</li>
<li><code>Future&lt;T&gt;</code>接口是实现多线程异步的核心，表示“能在未来得到计算结果的对象”，包括以下核心方法：
<ul>
<li><code>get()</code>：获取结果，如果其对应的计算任务尚未完成则会使调用<code>get()</code>的线程进入阻塞</li>
<li><code>get(long, TimeUnit)</code>：仅等待有限时间地获取结果</li>
<li><code>cancel(true)</code>：<code>true</code>表示通过发出中断请求来取消任务，若任务尚未开始或线程响应中断请求后则成功取消，返回<code>true</code>，否则返回<code>false</code>
<code>cancel(false)</code>：若任务尚未完成则一定能取消成功，但任务可以继续执行直至结束
成功调用<code>cancel()</code>后，<code>isCancelled()</code>返回<code>true</code>，此后<code>get()</code>会抛出<code>CancellationException</code>异常</li>
</ul></li>
<li><code>ExecutorService</code>接口：
<ul>
<li>任务提交：把任务提交给线程池，异步地执行
<code>Future&lt;T&gt; submit(Callable&lt;T&gt; task)</code>：提交一个计算任务给线程池执行，<strong>立刻</strong>获得一个<code>Future&lt;T&gt;</code>对象</li>
<li>任务执行：把多个任务提交给线程池，当前线程阻塞，即同步地执行
<code>List&lt;Future&lt;T&gt;&gt; invokeAll(List&lt;Callable&lt;T&gt;&gt;)</code>：执行多个计算任务，当前线程阻塞直至它们全部执行完成，返回值顺序和提交的任务顺序一致
<code>invokeAll()</code>还允许传递时间参数，有限地阻塞</li>
<li><code>shutdown()</code>：停止接受所有新线程，执行完已提交的线程，然后关闭线程池</li>
<li><code>shutdownNow()</code>：停止接受所有新线程，尝试中断地取消所有已提交线程，返回所有未开始的任务</li>
</ul></li>
<li>创建<code>ExecutorService</code>对象：
<ul>
<li><code>Executors</code></li>
<li><code>ThreadPoolExecutor</code></li>
</ul></li>
<li><code>Fork/Join</code>线程池：</li>
</ul>
<h3 id="其它api">其它<code>API</code></h3>
<ul>
<li><code>java.util.concurrent.atomic</code>中的类基于<code>CAS</code>机制实现无锁的线程同步，使用<strong>乐观锁</strong>、<strong>非阻塞</strong>地封装资源
例如<code>AtomicReferencte&lt;T&gt;、AtomicReferenceArray&lt;T&gt;</code>，除此之外还对三个基本数据类型有更全面的封装：<code>AtomicInteger、AtomicLong、AtomicBoolean</code>
如果<code>ABA</code>问题会影响业务逻辑，则应使用<code>AtomicStampedReference</code>或<code>AtomicMarkableReference</code>
以下是<code>AtomicReference</code>一系列常用的<strong>原子方法</strong>：
<ul>
<li><code>get()</code>：获取当前值</li>
<li><code>set(T)</code>：<code>volatile</code>地写入新值</li>
<li><code>compareAndSet(T ept, T upd)</code>：<code>CAS</code>地更新值，可能失败</li>
<li><code>getAndSet(T)</code>：获取旧值，写入新值</li>
<li><code>getAndUpdate()</code>或<code>updateAndGet()</code>：提供单元运算函数更新值，返回更新前/更新后的值</li>
<li><code>getAndAccumulate()</code>或<code>accumulateAndGet()</code>：提供二元运算函数和加值，返回更新前/更新后的值</li>
</ul></li>
<li>线程安全的集合：
<ul>
<li><code>List</code>的实现类<code>CopyOnWriteArrayList</code></li>
<li><code>Map</code>的实现类<code>ConcurrentHashMap</code></li>
<li><code>Set</code>的实现类<code>CopyOnWriteArraySet</code></li>
<li><code>Queue</code>的实现类<code>ArrayBlockingQueue</code>与<code>LinkedBlockingQueue</code></li>
<li><code>Deque</code>的实现类<code>LinkedBlockingDeque</code></li>
</ul></li>
<li><code>CompletableFuture</code></li>
<li><code>ThreadLocal</code></li>
<li>虚拟线程：</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="sidebar-inner sidebar-post-related">
            <div class="animated">
                <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/03/04/java-base/" rel="bookmark">
        <time class="popular-posts-time">2025-03-04</time>
        <br>
      Java: 基本语法
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/03/06/java-oop/" rel="bookmark">
        <time class="popular-posts-time">2025-03-06</time>
        <br>
      Java: 面向对象编程
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/05/04/java-stream-api/" rel="bookmark">
        <time class="popular-posts-time">2025-05-04</time>
        <br>
      Java: 函数式编程
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2025/07/14/spring-validation/" rel="bookmark">
        <time class="popular-posts-time">2025-07-14</time>
        <br>
      Spring framework: Validation API
      </a>
    </li>
  </ul>

            </div>
          </div>

          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/multithreading/" rel="tag"># multithreading</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/05/10/java-net/" rel="prev" title="Java: 网络编程基础">
                  <i class="fa fa-angle-left"></i> Java: 网络编程基础
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/05/19/WSL/" rel="next" title="WSL2: Windows下极其轻量的Linux虚拟机">
                  WSL2: Windows下极其轻量的Linux虚拟机 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ishio</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">241k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">14:38</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script>
(function() {
    if (document.readyState !== 'loading') {
        initCategoryCollapse();
    } else {
        document.addEventListener('DOMContentLoaded', initCategoryCollapse);
    }

    function initCategoryCollapse() {
        var categoryItems = document.querySelectorAll('.category-all-page .category-list-item');
        
        categoryItems.forEach(function(item) {
            var childList = item.querySelector('.category-list-child');
            
            if (childList) {
                var titleLink = item.querySelector('.category-list-link');
                if (!titleLink) return;
                
                item.classList.add('has-child');
                
                var toggleIcon = document.createElement('span');
                toggleIcon.className = 'collapse-icon';
                toggleIcon.innerHTML = ' ▸';
                titleLink.parentNode.insertBefore(toggleIcon, titleLink.nextSibling);
                
                childList.style.display = 'none';
                item.classList.add('collapsed');
                
                titleLink.style.cursor = 'pointer';
                titleLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    item.classList.toggle('collapsed');
                    if (item.classList.contains('collapsed')) {
                        childList.style.display = 'none';
                        toggleIcon.innerHTML = ' ▸';
                    } else {
                        childList.style.display = 'block';
                        toggleIcon.innerHTML = ' ▾';
                    }
                });
                
                toggleIcon.style.cursor = 'pointer';
                toggleIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    titleLink.click();
                });
            }
        });
    }
})();
</script>

</body>
</html>
